---
title: "`r params$title`"
output:
  rmarkdown::html_document:
    theme: cosmo
    toc: true
    toc_float: true
    self_contained: true
params:
  title: "GlySmith report"
  x: ~
  report_sections: ~
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

`%||%` <- function(x, y) if (is.null(x)) y else x

x <- params$x
report_sections <- params$report_sections
if (is.null(report_sections)) report_sections <- list()

.normalize_title <- function(x) {
  if (is.null(x) || !nzchar(x)) return("")
  x <- tolower(x)
  x <- gsub("[^a-z0-9]+", " ", x)
  trimws(x)
}

.has_content <- function(x) {
  is.character(x) && length(x) == 1 && nzchar(x)
}
```

## Overview

```{r}
plots_n <- if (is.null(x$plots)) 0L else length(x$plots)
tables_n <- if (is.null(x$tables)) 0L else length(x$tables)

knitr::kable(
  data.frame(
    item = c("Generated", "Plots", "Tables"),
    value = c(as.character(Sys.time()), plots_n, tables_n)
  ),
  format = "html"
)
```

```{r, results = "asis"}
if (length(report_sections) == 0) {
  cat("_No report sections available._\n")
} else {
  for (section in report_sections) {
    title <- section$title %||% "Analysis"
    entries <- section$entries %||% list()
    printable <- FALSE
    for (entry in entries) {
      if (!is.null(entry$type) && entry$type == "step" && .has_content(entry$content)) {
        printable <- TRUE
      }
      if (!is.null(entry$type) && entry$type == "plot" && !is.null(entry$plot)) {
        printable <- TRUE
      }
    }
    if (!printable) next
    cat("## ", title, "\n\n", sep = "")
    section_norm <- .normalize_title(title)
    for (entry in entries) {
      if (!is.null(entry$type) && entry$type == "step") {
        if (!.has_content(entry$content)) next
        label <- entry$label %||% entry$id
        label_norm <- .normalize_title(label)
        if (nzchar(section_norm) && label_norm == section_norm) {
          cat(entry$content, "\n\n", sep = "")
        } else {
          cat("### ", label, "\n\n", sep = "")
          cat(entry$content, "\n\n", sep = "")
        }
      }
      if (!is.null(entry$type) && entry$type == "plot") {
        label <- entry$label %||% entry$id
        cat("### ", label, "\n\n", sep = "")
        if (!is.null(entry$description) && nzchar(entry$description)) {
          desc_norm <- .normalize_title(entry$description)
          label_norm <- .normalize_title(label)
          if (!(nzchar(desc_norm) && desc_norm == label_norm)) {
            cat(entry$description, "\n\n", sep = "")
          }
        }
        if (!is.null(entry$plot)) print(entry$plot)
        cat("\n\n")
      }
    }
  }
}
```

## Session info

```{r}
utils::sessionInfo()
```

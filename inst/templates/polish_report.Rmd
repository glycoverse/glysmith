---
title: "`r params$title`"
output:
  rmarkdown::html_document:
    theme: cosmo
    toc: true
    toc_float: true
    self_contained: true
params:
  title: "GlySmith report"
  x: ~
  report_sections: ~
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

`%||%` <- function(x, y) if (is.null(x)) y else x

x <- params$x
report_sections <- params$report_sections
if (is.null(report_sections)) report_sections <- list()
```

## Overview

```{r}
plots_n <- if (is.null(x$plots)) 0L else length(x$plots)
tables_n <- if (is.null(x$tables)) 0L else length(x$tables)

knitr::kable(
  data.frame(
    item = c("Generated", "Plots", "Tables"),
    value = c(as.character(Sys.time()), plots_n, tables_n)
  ),
  format = "html"
)
```

```{r, results = "asis"}
if (length(report_sections) == 0) {
  cat("_No report sections available._\n")
} else {
  for (section in report_sections) {
    title <- section$title %||% "Analysis"
    cat("## ", title, "\n\n", sep = "")
    entries <- section$entries %||% list()
    if (length(entries) == 0) {
      cat("_No content for this section._\n\n")
      next
    }
    for (entry in entries) {
      if (!is.null(entry$type) && entry$type == "step") {
        label <- entry$label %||% entry$id
        cat("### ", label, "\n\n", sep = "")
        if (!is.null(entry$content) && is.character(entry$content) &&
          length(entry$content) == 1 && nzchar(entry$content)) {
          cat(entry$content, "\n\n", sep = "")
        } else {
          cat("_No report content for this step._\n\n")
        }
      }
      if (!is.null(entry$type) && entry$type == "plot") {
        label <- entry$label %||% entry$id
        cat("### ", label, "\n\n", sep = "")
        if (!is.null(entry$description) && nzchar(entry$description)) {
          cat(entry$description, "\n\n", sep = "")
        }
        if (!is.null(entry$plot)) print(entry$plot)
        cat("\n\n")
      }
    }
  }
}
```

## Session info

```{r}
utils::sessionInfo()
```
